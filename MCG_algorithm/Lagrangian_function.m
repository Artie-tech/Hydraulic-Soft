function [M,C,G,M_L,C_L,G_L] = Lagrangian_function(m,L,q,qd,Ix,Iy,Iz)

%  Authorï¼šManzhi Qi
%  Calculate the Lagrangian matrix (within 4 freedom of degrees)ml
%  m expresses the mass of the Joint
%  L expresses the length of the Joint
%  q,qd express the angular velocity  of joint respectively
%  Ix Iy Iz express the moment of inertia of joint 
%  m_load express the mass of load
%  M,C,G express the matrix of inertial\Coriolis force and centrifugal force\gravity
clc;
g = 9.8;

q_u = q;
qu_dot = qd;
r = L/2;
Ix1 = Ix(1); Ix2 = Ix(2); Ix3 = Ix(3); Ix4 = Ix(4);
Iy1 = Iy(1); Iy2 = Iy(2); Iy3 = Iy(3); Iy4 = Iy(4);
Iz1 = Iz(1); Iz2 = Iz(2); Iz3 = Iz(3); Iz4 = Iz(4);
q1 = q_u(1); q2 = q_u(2); q3 = q_u(3); q4 = q_u(4);
m1 = m(1); m2 = m(2); m3 = m(3); m4 = m(4);
r1 = r(1); r2 = r(2); r3 = r(3); r4 = r(4);
L1 = L(1); L2 = L(2); L3 = L(3); L4 = L(4);
q1d = qu_dot(1); q2d = qu_dot(2); q3d = qu_dot(3); q4d = qu_dot(4);


M_0 = [Ix2/2 + Ix3/2 + Ix4/2 + Iy2/2 + Iy3/2 + Iy4/2 + Iz1 - (Ix3*cos(2*q2 + 2*q3))/2 + (Iy3*cos(2*q2 + 2*q3))/2 + L1^2*m2 + L1^2*m3 + L1^2*m4 + (L2^2*m3)/2 + (L2^2*m4)/2 + (L3^2*m3)/2 + (L3^2*m4)/2 + m1*r1^2 + (m2*r2^2)/2 + (m4*r4^2)/2 - (Ix2*cos(2*q2))/2 + (Iy2*cos(2*q2))/2 - (Ix4*cos(2*q2 + 2*q3 + 2*q4))/2 + (Iy4*cos(2*q2 + 2*q3 + 2*q4))/2 + (L2^2*m3*cos(2*q2))/2 + (L2^2*m4*cos(2*q2))/2 + (m2*r2^2*cos(2*q2))/2 + (m4*r4^2*cos(2*q2 + 2*q3 + 2*q4))/2 + (L3^2*m3*cos(2*q2 + 2*q3))/2 + (L3^2*m4*cos(2*q2 + 2*q3))/2 + 2*L1*L3*m3*cos(q2 + q3) + 2*L1*L3*m4*cos(q2 + q3) + L2*m4*r4*cos(q3 + q4) + 2*L1*L2*m3*cos(q2) + 2*L1*L2*m4*cos(q2) + L2*L3*m3*cos(q3) + L2*L3*m4*cos(q3) + 2*L1*m2*r2*cos(q2) + L3*m4*r4*cos(q4) + L3*m4*r4*cos(2*q2 + 2*q3 + q4) + L2*L3*m3*cos(2*q2 + q3) + L2*L3*m4*cos(2*q2 + q3) + 2*L1*m4*r4*cos(q2 + q3 + q4) + L2*m4*r4*cos(2*q2 + q3 + q4), 0,  0,  0;
      0, Iz2 + Iz3 + Iz4 + L2^2*m3 + L2^2*m4 + L3^2*m4 + m2*r2^2 + m3*r3^2 + m4*r4^2 + 2*L2*m4*r4*cos(q3 + q4) + 2*L2*L3*m4*cos(q3) + 2*L2*m3*r3*cos(q3) + 2*L3*m4*r4*cos(q4), m4*L3^2 + 2*m4*cos(q4)*L3*r4 + L2*m4*cos(q3)*L3 + m3*r3^2 + L2*m3*cos(q3)*r3 + m4*r4^2 + L2*m4*cos(q3 + q4)*r4 + Iz3 + Iz4, Iz4 + m4*r4^2 + L2*m4*r4*cos(q3 + q4) + L3*m4*r4*cos(q4);
      0, m4*L3^2 + 2*m4*cos(q4)*L3*r4 + L2*m4*cos(q3)*L3 + m3*r3^2 + L2*m3*cos(q3)*r3 + m4*r4^2 + L2*m4*cos(q3 + q4)*r4 + Iz3 + Iz4,     m4*L3^2 + 2*m4*cos(q4)*L3*r4 + m3*r3^2 + m4*r4^2 + Iz3 + Iz4,      m4*r4^2 + L3*m4*cos(q4)*r4 + Iz4;
      0, Iz4 + m4*r4^2 + L2*m4*r4*cos(q3 + q4) + L3*m4*r4*cos(q4),  m4*r4^2 + L3*m4*cos(q4)*r4 + Iz4,    m4*r4^2 + Iz4]
 
C_0 = [(Ix2*q2d*sin(2*q2))/2 - (Iy2*q2d*sin(2*q2))/2 + (Ix4*q2d*sin(2*q2 + 2*q3 + 2*q4))/2 + (Ix4*q3d*sin(2*q2 + 2*q3 + 2*q4))/2 + (Ix4*q4d*sin(2*q2 + 2*q3 + 2*q4))/2 - (Iy4*q2d*sin(2*q2 + 2*q3 + 2*q4))/2 - (Iy4*q3d*sin(2*q2 + 2*q3 + 2*q4))/2 - (Iy4*q4d*sin(2*q2 + 2*q3 + 2*q4))/2 + (Ix3*q2d*sin(2*q2 + 2*q3))/2 + (Ix3*q3d*sin(2*q2 + 2*q3))/2 - (Iy3*q2d*sin(2*q2 + 2*q3))/2 - (Iy3*q3d*sin(2*q2 + 2*q3))/2 - (L2^2*m3*q2d*sin(2*q2))/2 - (L2^2*m4*q2d*sin(2*q2))/2 - (m2*q2d*r2^2*sin(2*q2))/2 - (m4*q2d*r4^2*sin(2*q2 + 2*q3 + 2*q4))/2 - (m4*q3d*r4^2*sin(2*q2 + 2*q3 + 2*q4))/2 - (m4*q4d*r4^2*sin(2*q2 + 2*q3 + 2*q4))/2 - (L3^2*m3*q2d*sin(2*q2 + 2*q3))/2 - (L3^2*m3*q3d*sin(2*q2 + 2*q3))/2 - (L3^2*m4*q2d*sin(2*q2 + 2*q3))/2 - (L3^2*m4*q3d*sin(2*q2 + 2*q3))/2 - L1*m4*q2d*r4*sin(q2 + q3 + q4) - L1*m4*q3d*r4*sin(q2 + q3 + q4) - L1*m4*q4d*r4*sin(q2 + q3 + q4) - L2*m4*q2d*r4*sin(2*q2 + q3 + q4) - (L2*m4*q3d*r4*sin(2*q2 + q3 + q4))/2 - (L2*m4*q4d*r4*sin(2*q2 + q3 + q4))/2 - L1*L3*m3*q2d*sin(q2 + q3) - L1*L3*m3*q3d*sin(q2 + q3) - L1*L3*m4*q2d*sin(q2 + q3) - L1*L3*m4*q3d*sin(q2 + q3) - (L2*m4*q3d*r4*sin(q3 + q4))/2 - (L2*m4*q4d*r4*sin(q3 + q4))/2 - L1*L2*m3*q2d*sin(q2) - L1*L2*m4*q2d*sin(q2) - (L2*L3*m3*q3d*sin(q3))/2 - (L2*L3*m4*q3d*sin(q3))/2 - L1*m2*q2d*r2*sin(q2) - (L3*m4*q4d*r4*sin(q4))/2 - L3*m4*q2d*r4*sin(2*q2 + 2*q3 + q4) - L3*m4*q3d*r4*sin(2*q2 + 2*q3 + q4) - (L3*m4*q4d*r4*sin(2*q2 + 2*q3 + q4))/2 - L2*L3*m3*q2d*sin(2*q2 + q3) - (L2*L3*m3*q3d*sin(2*q2 + q3))/2 - L2*L3*m4*q2d*sin(2*q2 + q3) - (L2*L3*m4*q3d*sin(2*q2 + q3))/2, -q1d*((Iy3*sin(2*q2 + 2*q3))/2 - (Ix3*sin(2*q2 + 2*q3))/2 - (Ix2*sin(2*q2))/2 + (Iy2*sin(2*q2))/2 - (Ix4*sin(2*q2 + 2*q3 + 2*q4))/2 + (Iy4*sin(2*q2 + 2*q3 + 2*q4))/2 + (L2^2*m3*sin(2*q2))/2 + (L2^2*m4*sin(2*q2))/2 + (m2*r2^2*sin(2*q2))/2 + (m4*r4^2*sin(2*q2 + 2*q3 + 2*q4))/2 + (L3^2*m3*sin(2*q2 + 2*q3))/2 + (L3^2*m4*sin(2*q2 + 2*q3))/2 + L2*m4*r4*sin(2*q2 + q3 + q4) + L1*L3*m3*sin(q2 + q3) + L1*L3*m4*sin(q2 + q3) + L1*L2*m3*sin(q2) + L1*L2*m4*sin(q2) + L1*m2*r2*sin(q2) + L3*m4*r4*sin(2*q2 + 2*q3 + q4) + L2*L3*m3*sin(2*q2 + q3) + L2*L3*m4*sin(2*q2 + q3) + L1*m4*r4*sin(q2 + q3 + q4)), -q1d*((Iy3*sin(2*q2 + 2*q3))/2 - (Ix3*sin(2*q2 + 2*q3))/2 - (Ix4*sin(2*q2 + 2*q3 + 2*q4))/2 + (Iy4*sin(2*q2 + 2*q3 + 2*q4))/2 + (m4*r4^2*sin(2*q2 + 2*q3 + 2*q4))/2 + (L3^2*m3*sin(2*q2 + 2*q3))/2 + (L3^2*m4*sin(2*q2 + 2*q3))/2 + (L2*m4*r4*sin(2*q2 + q3 + q4))/2 + L1*L3*m3*sin(q2 + q3) + L1*L3*m4*sin(q2 + q3) + (L2*m4*r4*sin(q3 + q4))/2 + (L2*L3*m3*sin(q3))/2 + (L2*L3*m4*sin(q3))/2 + L3*m4*r4*sin(2*q2 + 2*q3 + q4) + (L2*L3*m3*sin(2*q2 + q3))/2 + (L2*L3*m4*sin(2*q2 + q3))/2 + L1*m4*r4*sin(q2 + q3 + q4)), -q1d*((Iy4*sin(2*q2 + 2*q3 + 2*q4))/2 - (Ix4*sin(2*q2 + 2*q3 + 2*q4))/2 + (m4*r4^2*sin(2*q2 + 2*q3 + 2*q4))/2 + (L2*m4*r4*sin(2*q2 + q3 + q4))/2 + (L2*m4*r4*sin(q3 + q4))/2 + (L3*m4*r4*sin(q4))/2 + (L3*m4*r4*sin(2*q2 + 2*q3 + q4))/2 + L1*m4*r4*sin(q2 + q3 + q4));
       q1d*((Iy3*sin(2*q2 + 2*q3))/2 - (Ix3*sin(2*q2 + 2*q3))/2 - (Ix2*sin(2*q2))/2 + (Iy2*sin(2*q2))/2 - (Ix4*sin(2*q2 + 2*q3 + 2*q4))/2 + (Iy4*sin(2*q2 + 2*q3 + 2*q4))/2 + (L2^2*m3*sin(2*q2))/2 + (L2^2*m4*sin(2*q2))/2 + (m2*r2^2*sin(2*q2))/2 + (m4*r4^2*sin(2*q2 + 2*q3 + 2*q4))/2 + (L3^2*m3*sin(2*q2 + 2*q3))/2 + (L3^2*m4*sin(2*q2 + 2*q3))/2 + L2*m4*r4*sin(2*q2 + q3 + q4) + L1*L3*m3*sin(q2 + q3) + L1*L3*m4*sin(q2 + q3) + L1*L2*m3*sin(q2) + L1*L2*m4*sin(q2) + L1*m2*r2*sin(q2) + L3*m4*r4*sin(2*q2 + 2*q3 + q4) + L2*L3*m3*sin(2*q2 + q3) + L2*L3*m4*sin(2*q2 + q3) + L1*m4*r4*sin(q2 + q3 + q4)),                                                                                                                                                                                                        - L2*q3d*(m3*r3*sin(q3) + m4*r4*sin(q3 + q4) + L3*m4*sin(q3)) - m4*q4d*r4*(L2*sin(q3 + q4) + L3*sin(q4)), - L2*q2d*(m3*r3*sin(q3) + m4*r4*sin(q3 + q4) + L3*m4*sin(q3)) - L2*q3d*(m3*r3*sin(q3) + m4*r4*sin(q3 + q4) + L3*m4*sin(q3)) - m4*q4d*r4*(L2*sin(q3 + q4) + L3*sin(q4)),                                                                                                                                                                                                                -m4*r4*(L2*sin(q3 + q4) + L3*sin(q4))*(q2d + q3d + q4d);
       q1d*((Iy3*sin(2*q2 + 2*q3))/2 - (Ix3*sin(2*q2 + 2*q3))/2 - (Ix4*sin(2*q2 + 2*q3 + 2*q4))/2 + (Iy4*sin(2*q2 + 2*q3 + 2*q4))/2 + (m4*r4^2*sin(2*q2 + 2*q3 + 2*q4))/2 + (L3^2*m3*sin(2*q2 + 2*q3))/2 + (L3^2*m4*sin(2*q2 + 2*q3))/2 + (L2*m4*r4*sin(2*q2 + q3 + q4))/2 + L1*L3*m3*sin(q2 + q3) + L1*L3*m4*sin(q2 + q3) + (L2*m4*r4*sin(q3 + q4))/2 + (L2*L3*m3*sin(q3))/2 + (L2*L3*m4*sin(q3))/2 + L3*m4*r4*sin(2*q2 + 2*q3 + q4) + (L2*L3*m3*sin(2*q2 + q3))/2 + (L2*L3*m4*sin(2*q2 + q3))/2 + L1*m4*r4*sin(q2 + q3 + q4)),                                                                                                                                                                                                                                               L2*q2d*(m3*r3*sin(q3) + m4*r4*sin(q3 + q4) + L3*m4*sin(q3)) - L3*m4*q4d*r4*sin(q4),  -L3*m4*q4d*r4*sin(q4),                                                                                                                                                                                                                                    -L3*m4*r4*sin(q4)*(q2d + q3d + q4d);
       q1d*((Iy4*sin(2*q2 + 2*q3 + 2*q4))/2 - (Ix4*sin(2*q2 + 2*q3 + 2*q4))/2 + (m4*r4^2*sin(2*q2 + 2*q3 + 2*q4))/2 + (L2*m4*r4*sin(2*q2 + q3 + q4))/2 + (L2*m4*r4*sin(q3 + q4))/2 + (L3*m4*r4*sin(q4))/2 + (L3*m4*r4*sin(2*q2 + 2*q3 + q4))/2 + L1*m4*r4*sin(q2 + q3 + q4)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                m4*r4*(L3*q2d*sin(q4) + L3*q3d*sin(q4) + L2*q2d*sin(q3 + q4)),                                                                        L3*m4*r4*sin(q4)*(q2d + q3d),  0]
 
G_0 = [  0;
g*(m2*r2*cos(q2) + m4*r4*cos(q2 + q3 + q4) + L3*m4*cos(q2 + q3) + m3*r3*cos(q2 + q3) + L2*m3*cos(q2) + L2*m4*cos(q2));
                                              L3*g*m4*cos(q2 + q3) + g*m3*r3*cos(q2 + q3) + g*m4*r4*cos(q2 + q3 + q4);
                                                                                            g*m4*r4*cos(q2 + q3 + q4)];

M_L = [(L2^2*cos(2*q2))/2 + (L4^2*cos(2*q2 + 2*q3 + 2*q4))/2 + (L3^2*cos(2*q2 + 2*q3))/2 + L1^2 + L2^2/2 + L3^2/2 + L4^2/2 + 2*L1*L4*cos(q2 + q3 + q4) + L2*L4*cos(2*q2 + q3 + q4) + 2*L1*L3*cos(q2 + q3) + L2*L4*cos(q3 + q4) + 2*L1*L2*cos(q2) + L2*L3*cos(q3) + L3*L4*cos(q4) + L3*L4*cos(2*q2 + 2*q3 + q4) + L2*L3*cos(2*q2 + q3),    0,     0,  0;
      0, L2^2 + 2*cos(q3)*L2*L3 + 2*cos(q3 + q4)*L2*L4 + L3^2 + 2*cos(q4)*L3*L4 + L4^2, L3^2 + 2*cos(q4)*L3*L4 + L2*cos(q3)*L3 + L4^2 + L2*cos(q3 + q4)*L4, L4*(L4 + L2*cos(q3 + q4) + L3*cos(q4));
      0, L3^2 + 2*cos(q4)*L3*L4 + L2*cos(q3)*L3 + L4^2 + L2*cos(q3 + q4)*L4,      L3^2 + 2*cos(q4)*L3*L4 + L4^2,      L4^2 + L3*cos(q4)*L4;
      0, L4*(L4 + L2*cos(q3 + q4) + L3*cos(q4)),        L4^2 + L3*cos(q4)*L4,    L4^2];
 
 
C_L = [- (L2^2*q2d*sin(2*q2))/2 - (L4^2*q2d*sin(2*q2 + 2*q3 + 2*q4))/2 - (L4^2*q3d*sin(2*q2 + 2*q3 + 2*q4))/2 - (L4^2*q4d*sin(2*q2 + 2*q3 + 2*q4))/2 - (L3^2*q2d*sin(2*q2 + 2*q3))/2 - (L3^2*q3d*sin(2*q2 + 2*q3))/2 - L1*L3*q2d*sin(q2 + q3) - L1*L3*q3d*sin(q2 + q3) - (L2*L4*q3d*sin(q3 + q4))/2 - (L2*L4*q4d*sin(q3 + q4))/2 - L1*L2*q2d*sin(q2) - (L2*L3*q3d*sin(q3))/2 - (L3*L4*q4d*sin(q4))/2 - L3*L4*q2d*sin(2*q2 + 2*q3 + q4) - L3*L4*q3d*sin(2*q2 + 2*q3 + q4) - (L3*L4*q4d*sin(2*q2 + 2*q3 + q4))/2 - L2*L3*q2d*sin(2*q2 + q3) - (L2*L3*q3d*sin(2*q2 + q3))/2 - L1*L4*q2d*sin(q2 + q3 + q4) - L1*L4*q3d*sin(q2 + q3 + q4) - L1*L4*q4d*sin(q2 + q3 + q4) - L2*L4*q2d*sin(2*q2 + q3 + q4) - (L2*L4*q3d*sin(2*q2 + q3 + q4))/2 - (L2*L4*q4d*sin(2*q2 + q3 + q4))/2, -(q1d*(sin(2*q2)*L2^2 + 2*sin(2*q2 + q3)*L2*L3 + 2*sin(2*q2 + q3 + q4)*L2*L4 + 2*L1*sin(q2)*L2 + sin(2*q2 + 2*q3)*L3^2 + 2*sin(2*q2 + 2*q3 + q4)*L3*L4 + 2*L1*sin(q2 + q3)*L3 + sin(2*q2 + 2*q3 + 2*q4)*L4^2 + 2*L1*sin(q2 + q3 + q4)*L4))/2, -(q1d*(L4^2*sin(2*q2 + 2*q3 + 2*q4) + L3^2*sin(2*q2 + 2*q3) + L2*L3*sin(2*q2 + q3) + 2*L1*L4*sin(q2 + q3 + q4) + L2*L4*sin(2*q2 + q3 + q4) + 2*L1*L3*sin(q2 + q3) + L2*L4*sin(q3 + q4) + L2*L3*sin(q3) + 2*L3*L4*sin(2*q2 + 2*q3 + q4)))/2, -(L4*q1d*(L2*sin(2*q2 + q3 + q4) + L2*sin(q3 + q4) + L3*sin(q4) + L3*sin(2*q2 + 2*q3 + q4) + 2*L1*sin(q2 + q3 + q4) + L4*sin(2*q2 + 2*q3 + 2*q4)))/2;
       (q1d*(sin(2*q2)*L2^2 + 2*sin(2*q2 + q3)*L2*L3 + 2*sin(2*q2 + q3 + q4)*L2*L4 + 2*L1*sin(q2)*L2 + sin(2*q2 + 2*q3)*L3^2 + 2*sin(2*q2 + 2*q3 + q4)*L3*L4 + 2*L1*sin(q2 + q3)*L3 + sin(2*q2 + 2*q3 + 2*q4)*L4^2 + 2*L1*sin(q2 + q3 + q4)*L4))/2,  - L2*L4*q3d*sin(q3 + q4) - L2*L4*q4d*sin(q3 + q4) - L2*L3*q3d*sin(q3) - L3*L4*q4d*sin(q4),   - L2*L4*q2d*sin(q3 + q4) - L2*L4*q3d*sin(q3 + q4) - L2*L4*q4d*sin(q3 + q4) - L2*L3*q2d*sin(q3) - L2*L3*q3d*sin(q3) - L3*L4*q4d*sin(q4),         -L4*(L2*sin(q3 + q4) + L3*sin(q4))*(q2d + q3d + q4d);
       (q1d*(L4^2*sin(2*q2 + 2*q3 + 2*q4) + L3^2*sin(2*q2 + 2*q3) + L2*L3*sin(2*q2 + q3) + 2*L1*L4*sin(q2 + q3 + q4) + L2*L4*sin(2*q2 + q3 + q4) + 2*L1*L3*sin(q2 + q3) + L2*L4*sin(q3 + q4) + L2*L3*sin(q3) + 2*L3*L4*sin(2*q2 + 2*q3 + q4)))/2,     L2*L4*q2d*sin(q3 + q4) + L2*L3*q2d*sin(q3) - L3*L4*q4d*sin(q4),        -L3*L4*q4d*sin(q4),       -L3*L4*sin(q4)*(q2d + q3d + q4d);
       (L4*q1d*(L2*sin(2*q2 + q3 + q4) + L2*sin(q3 + q4) + L3*sin(q4) + L3*sin(2*q2 + 2*q3 + q4) + 2*L1*sin(q2 + q3 + q4) + L4*sin(2*q2 + 2*q3 + 2*q4)))/2,  L4*(L3*q2d*sin(q4) + L3*q3d*sin(q4) + L2*q2d*sin(q3 + q4)),   L3*L4*sin(q4)*(q2d + q3d),     0];
      
                                                                                        
                                                                                        
G_L =  [0;
g*(L3*cos(q2 + q3) + L2*cos(q2) + L4*cos(q2 + q3 + q4));
             L4*g*cos(q2 + q3 + q4) + L3*g*cos(q2 + q3);
                                 L4*g*cos(q2 + q3 + q4)];

end